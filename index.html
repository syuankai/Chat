<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ULTRA VIP TERMINAL v4.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&family=JetBrains+Mono&display=swap');
        
        body { font-family: 'Noto Sans TC', sans-serif; background: #1e1f22; color: #fff; overflow: hidden; margin: 0; }
        
        /* 側邊導航動畫 */
        #side-drawer { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 100; }
        .drawer-open { transform: translateX(0) !important; }
        .drawer-overlay { background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); transition: opacity 0.3s; }
        
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .msg-bubble { max-width: 85%; padding: 12px 16px; border-radius: 18px; font-size: 14px; line-height: 1.6; }
        .my-msg { background: #5865f2; color: #fff; border-bottom-right-radius: 4px; }
        .other-msg { background: #2b2d31; color: #dbdee1; border-bottom-left-radius: 4px; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .view-section { position: absolute; inset: 0; background: #313338; display: flex; flex-direction: column; }
        .hidden-view { display: none !important; }
    </style>
</head>
<body class="h-screen flex flex-col">

    <!-- 加載遮罩 -->
    <div id="loader" class="fixed inset-0 z-[1000] bg-[#0b0b0d] flex flex-col items-center justify-center">
        <div class="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
        <p id="loader-text" class="mt-4 font-mono text-blue-500 text-[10px] tracking-[0.5em] animate-pulse uppercase">Connecting to Node</p>
    </div>

    <!-- 登入頁面 -->
    <div id="login-page" class="fixed inset-0 z-[500] bg-[#1e1f22] flex items-center justify-center p-6">
        <div class="w-full max-w-sm space-y-8">
            <div class="text-center">
                <div class="inline-flex p-4 bg-blue-600 rounded-3xl rotate-12 shadow-2xl shadow-blue-600/30 mb-6">
                    <i class="fa-solid fa-crown text-3xl text-white"></i>
                </div>
                <h2 class="text-3xl font-black italic">ULTRA VIP</h2>
                <p class="text-zinc-500 text-xs mt-2 tracking-widest uppercase">Mobile Terminal</p>
            </div>

            <div class="glass p-8 rounded-[2.5rem] space-y-4">
                <div class="space-y-2">
                    <input type="text" id="auth-user" placeholder="名稱" class="w-full bg-black/40 border border-white/5 p-4 rounded-2xl text-sm outline-none focus:border-blue-500">
                    <input type="password" id="auth-pass" placeholder="密碼" class="w-full bg-black/40 border border-white/5 p-4 rounded-2xl text-sm outline-none focus:border-blue-500">
                </div>
                <button onclick="handleManualAuth()" class="w-full bg-blue-600 hover:bg-blue-500 py-4 rounded-2xl font-bold shadow-xl shadow-blue-600/20 active:scale-95 transition-all">
                    進入系統
                </button>
                <button onclick="loginWithGoogle()" class="w-full bg-white text-black font-bold py-4 rounded-2xl flex items-center justify-center gap-3 active:scale-95 transition-all text-sm">
                    <img src="https://www.gstatic.com/images/branding/product/1x/gsa_512dp.png" class="w-5 h-5">
                    Google 登入
                </button>
                <button onclick="startGuestSession()" class="w-full text-zinc-500 text-xs font-bold py-2 hover:text-blue-400">
                    <i class="fa-solid fa-bolt mr-1"></i> 直接試用
                </button>
            </div>
        </div>
    </div>

    <!-- 主程式介面 -->
    <div id="app" class="flex-1 flex flex-col hidden">
        
        <header class="h-16 bg-[#2b2d31] border-b border-black/20 flex items-center justify-between px-4 z-50">
            <div class="flex items-center gap-3">
                <button onclick="toggleDrawer(true)" class="w-10 h-10 flex items-center justify-center text-zinc-400">
                    <i class="fa-solid fa-bars-staggered text-xl"></i>
                </button>
                <div class="flex flex-col">
                    <span id="view-title" class="font-black text-sm text-zinc-100">主介面</span>
                    <span id="view-subtitle" class="text-[9px] text-zinc-500 font-bold uppercase">Public Terminal</span>
                </div>
            </div>
            <button onclick="openTab('player')" class="w-10 h-10 flex items-center justify-center text-blue-400">
                <i class="fa-solid fa-headphones"></i>
            </button>
        </header>

        <main class="flex-1 relative overflow-hidden">
            <!-- 視圖: 聊天 -->
            <section id="view-chat" class="view-section">
                <div id="chat-messages" class="flex-1 overflow-y-auto p-4 flex flex-col gap-4 no-scrollbar"></div>
                <div class="p-4 bg-[#313338]">
                    <div class="bg-[#383a40] rounded-2xl px-4 flex items-center gap-3 border border-white/5 shadow-lg">
                        <input id="msg-input" type="text" placeholder="輸入訊息..." class="flex-1 bg-transparent py-4 outline-none text-sm text-white">
                        <button onclick="sendMsg()" class="text-blue-500 px-2"><i class="fa-solid fa-paper-plane text-xl"></i></button>
                    </div>
                </div>
            </section>

            <!-- 視圖: 設定 -->
            <section id="view-settings" class="view-section hidden-view p-8 overflow-y-auto">
                <div class="max-w-md mx-auto space-y-6">
                    <h3 class="text-2xl font-black">帳戶設定</h3>
                    <div class="space-y-4">
                        <img id="set-avatar" class="w-20 h-20 rounded-2xl mx-auto border-2 border-blue-500/30" src="">
                        <div>
                            <label class="text-[10px] text-zinc-500 uppercase font-bold ml-1">顯示名稱</label>
                            <input id="set-name" type="text" class="w-full bg-black/40 border border-white/5 p-4 rounded-xl text-sm mt-1 outline-none focus:border-blue-500">
                        </div>
                        <div>
                            <label class="text-[10px] text-zinc-500 uppercase font-bold ml-1">播放器 (SoundCloud URL)</label>
                            <input id="set-player-url" type="text" class="w-full bg-black/40 border border-white/5 p-4 rounded-xl text-sm mt-1 outline-none focus:border-blue-500">
                        </div>
                        <button onclick="saveProfile()" class="w-full bg-blue-600 py-4 rounded-xl font-bold shadow-lg">儲存變更</button>
                        <button onclick="logout()" class="w-full text-zinc-600 text-[10px] font-bold uppercase py-4">退出登入</button>
                    </div>
                </div>
            </section>

            <!-- 視圖: 播放器 -->
            <section id="view-player" class="view-section hidden-view bg-[#1e1f22] items-center justify-center p-6">
                <div class="w-full max-w-sm glass p-6 rounded-[2.5rem] shadow-2xl">
                    <div class="aspect-square rounded-3xl overflow-hidden bg-black mb-6">
                        <iframe id="sc-iframe" width="100%" height="100%" scrolling="no" frameborder="no" allow="autoplay" src=""></iframe>
                    </div>
                    <div class="flex justify-center gap-6">
                        <button class="w-12 h-12 rounded-full bg-white/5 flex items-center justify-center"><i class="fa-solid fa-backward-step"></i></button>
                        <button class="w-16 h-16 rounded-full bg-blue-600 flex items-center justify-center text-xl"><i class="fa-solid fa-play"></i></button>
                        <button class="w-12 h-12 rounded-full bg-white/5 flex items-center justify-center"><i class="fa-solid fa-forward-step"></i></button>
                    </div>
                </div>
            </section>
        </main>

        <!-- 側邊抽屜 -->
        <div id="drawer-overlay" onclick="toggleDrawer(false)" class="fixed inset-0 drawer-overlay opacity-0 pointer-events-none z-[90]"></div>
        <aside id="side-drawer" class="fixed top-0 left-0 bottom-0 w-72 bg-[#2b2d31] -translate-x-full shadow-2xl flex flex-col z-[100]">
            <div class="p-8 border-b border-black/10 flex items-center gap-3">
                <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center shadow-lg"><i class="fa-solid fa-crown text-white"></i></div>
                <h4 class="font-black italic">VIP MENU</h4>
            </div>
            <nav class="flex-1 p-4 space-y-2 mt-4">
                <button onclick="openTab('chat')" class="nav-btn w-full flex items-center gap-4 p-4 rounded-2xl bg-white/5 text-zinc-100 font-bold"><i class="fa-solid fa-comments text-blue-500"></i> 主介面</button>
                <button onclick="openTab('settings')" class="nav-btn w-full flex items-center gap-4 p-4 rounded-2xl text-zinc-400 font-bold"><i class="fa-solid fa-user-gear"></i> 個人設定</button>
                <button onclick="openTab('player')" class="nav-btn w-full flex items-center gap-4 p-4 rounded-2xl text-zinc-400 font-bold"><i class="fa-solid fa-music"></i> 播放器</button>
            </nav>
            <div class="p-6 bg-[#232428] flex items-center gap-3">
                <img id="dr-avatar" class="w-10 h-10 rounded-full" src="">
                <div class="overflow-hidden">
                    <p id="dr-name" class="text-xs font-black truncate">User</p>
                    <p class="text-[9px] text-green-500 font-bold uppercase">Verified</p>
                </div>
            </div>
        </aside>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBi_Js2F0UbFL7VS_bP5ZCgquWPn1f0QUg",
            authDomain: "my-chat-a7162.firebaseapp.com",
            projectId: "my-chat-a7162",
            storageBucket: "my-chat-a7162.firebasestorage.app",
            messagingSenderId: "940121204402",
            appId: "1:940121204402:web:edd47e839d2f8fb34a8bab"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let profile = { name: '訪客', player: 'https://m.soundcloud.com/unapersona-519011028/sets/forsken-ost' };
        let currentUID = null;

        // --- 初始化 & 攔截修復 ---
        onAuthStateChanged(auth, async (u) => {
            if (u) {
                currentUID = u.uid;
                await fetchProfile();
                showApp();
            } else {
                showLogin();
            }
            hideLoader();
        });

        function showApp() {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            updateUI();
            openTab('chat');
            listenChat();
        }

        function showLogin() {
            document.getElementById('login-page').classList.remove('hidden');
            document.getElementById('app').classList.add('hidden');
        }

        function hideLoader() {
            document.getElementById('loader').classList.add('hidden');
        }

        // --- 驗證邏輯 ---
        window.handleManualAuth = async () => {
            const name = document.getElementById('auth-user').value.trim();
            const pass = document.getElementById('auth-pass').value.trim();
            if(!name || !pass) return alert("請輸入資訊");
            
            document.getElementById('loader').classList.remove('hidden');
            try {
                const userRef = doc(db, "vip_users", name);
                const snap = await getDoc(userRef);
                if(snap.exists() && snap.data().pw !== pass) {
                    hideLoader();
                    return alert("密碼錯誤");
                }
                if(!snap.exists()) await setDoc(userRef, { pw: pass });
                
                profile.name = name;
                await signInAnonymously(auth);
                await setDoc(doc(db, "user_profiles", auth.currentUser.uid), profile);
            } catch(e) { console.error(e); hideLoader(); }
        };

        window.startGuestSession = async () => {
            document.getElementById('loader').classList.remove('hidden');
            try {
                await signInAnonymously(auth);
                profile.name = "Guest_" + Math.random().toString(36).substring(7);
                showApp();
            } catch(e) { console.error(e); hideLoader(); }
        };

        window.loginWithGoogle = () => signInWithPopup(auth, provider);

        async function fetchProfile() {
            if(!auth.currentUser) return;
            const d = await getDoc(doc(db, "user_profiles", auth.currentUser.uid));
            if(d.exists()) profile = d.data();
        }

        function updateUI() {
            const photo = `https://ui-avatars.com/api/?name=${profile.name}&background=5865f2&color=fff&bold=true`;
            document.getElementById('dr-avatar').src = photo;
            document.getElementById('set-avatar').src = photo;
            document.getElementById('dr-name').innerText = profile.name;
            document.getElementById('set-name').value = profile.name;
            document.getElementById('set-player-url').value = profile.player;
            document.getElementById('sc-iframe').src = `https://w.soundcloud.com/player/?url=${encodeURIComponent(profile.player)}&color=%235865f2&auto_play=false&visual=true`;
        }

        // --- 導航 ---
        window.toggleDrawer = (show) => {
            const drawer = document.getElementById('side-drawer');
            const overlay = document.getElementById('drawer-overlay');
            if(show) {
                drawer.classList.add('drawer-open');
                overlay.classList.remove('pointer-events-none');
                overlay.style.opacity = '1';
            } else {
                drawer.classList.remove('drawer-open');
                overlay.classList.add('pointer-events-none');
                overlay.style.opacity = '0';
            }
        };

        window.openTab = (tabId) => {
            const sections = { chat: 'view-chat', settings: 'view-settings', player: 'view-player' };
            const titles = { chat: '主介面', settings: '帳戶中心', player: '音樂播放器' };
            
            Object.values(sections).forEach(id => document.getElementById(id).classList.add('hidden-view'));
            document.getElementById(sections[tabId]).classList.remove('hidden-view');
            document.getElementById('view-title').innerText = titles[tabId];
            
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('bg-white/5', 'text-zinc-100'));
            toggleDrawer(false);
        };

        // --- 聊天 ---
        let chatSub = null;
        function listenChat() {
            if(chatSub) chatSub();
            const q = query(collection(db, "public_chats/lobby/messages"), orderBy("time", "asc"));
            chatSub = onSnapshot(q, (snap) => {
                const box = document.getElementById('chat-messages');
                box.innerHTML = '';
                snap.forEach(d => {
                    const m = d.data();
                    const isMe = m.uid === currentUID;
                    box.innerHTML += `
                        <div class="flex flex-col ${isMe ? 'items-end' : 'items-start'}">
                            <span class="text-[9px] text-zinc-500 font-bold mb-1 uppercase">${m.author}</span>
                            <div class="msg-bubble ${isMe ? 'my-msg' : 'other-msg'}">${m.text}</div>
                        </div>
                    `;
                });
                box.scrollTop = box.scrollHeight;
            });
        }

        window.sendMsg = async () => {
            const inp = document.getElementById('msg-input');
            if(!inp.value.trim() || !currentUID) return;
            const text = inp.value; inp.value = '';
            await addDoc(collection(db, "public_chats/lobby/messages"), {
                uid: currentUID,
                author: profile.name,
                text,
                time: serverTimestamp()
            });
        };

        window.saveProfile = async () => {
            profile.name = document.getElementById('set-name').value;
            profile.player = document.getElementById('set-player-url').value;
            await setDoc(doc(db, "user_profiles", currentUID), profile);
            updateUI();
            alert("已儲存");
        };

        window.logout = () => signOut(auth).then(() => location.reload());
        document.getElementById('msg-input').onkeydown = (e) => e.key === 'Enter' && sendMsg();
    </script>
</body>
</html>

